{% extends "admin_base.html" %}
{% block title %}Appointment Types{% endblock %}
{% block content %}
<h1>Appointment Types</h1>

{% if types %}
<table style="margin-bottom:2rem;">
  <thead>
    <tr><th>Name</th><th>Duration</th><th>Buffer</th><th>Calendar</th><th>Status</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% for t in types %}
  <tr>
    <td>
      <strong>{{ t.name }}</strong>
      {% if t.description %}<br><small style="color:#64748b;">{{ t.description }}</small>{% endif %}
    </td>
    <td>{{ t.duration_minutes }} min</td>
    <td>{% if t.buffer_before_minutes %}{{ t.buffer_before_minutes }}m before / {% endif %}{{ t.buffer_after_minutes }}m after</td>
    <td><code style="font-size:.8rem;">{{ t.calendar_id }}</code></td>
    <td>{% if t.active %}<span style="color:#059669;">Active</span>{% else %}<span style="color:#dc2626;">Inactive</span>{% endif %}</td>
    <td style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <a href="/admin/appointment-types/{{ t.id }}/edit" class="btn btn-secondary" style="font-size:.8rem;padding:.3rem .6rem;">Edit</a>
      <form method="post" action="/admin/appointment-types/{{ t.id }}/toggle">
        <button class="btn btn-secondary" style="font-size:.8rem;padding:.3rem .6rem;">
          {% if t.active %}Disable{% else %}Enable{% endif %}
        </button>
      </form>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p style="color:#64748b;margin-bottom:1.5rem;">No appointment types yet. Create one below.</p>
{% endif %}

<div class="card" style="cursor:default;max-width:520px;">
  <h2>{% if edit_type %}Edit: {{ edit_type.name }}{% else %}New Appointment Type{% endif %}</h2>
  <form method="post" action="{% if edit_type %}/admin/appointment-types/{{ edit_type.id }}{% else %}/admin/appointment-types{% endif %}" style="margin-top:1rem;">
    <label>Name *
      <input type="text" name="name" value="{{ edit_type.name if edit_type else '' }}" required>
    </label>
    <label>Description
      <input type="text" name="description" value="{{ edit_type.description if edit_type else '' }}">
    </label>
    <label>Duration (minutes) *
      <input type="number" name="duration_minutes" value="{{ edit_type.duration_minutes if edit_type else 30 }}" required min="5">
    </label>
    <label>Buffer before (minutes)
      <input type="number" name="buffer_before_minutes" value="{{ edit_type.buffer_before_minutes if edit_type else 0 }}" min="0">
    </label>
    <label>Buffer after (minutes)
      <input type="number" name="buffer_after_minutes" value="{{ edit_type.buffer_after_minutes if edit_type else 0 }}" min="0">
    </label>
    <label>Google Calendar ID
      <input type="text" name="calendar_id" value="{{ edit_type.calendar_id if edit_type else 'primary' }}">
    </label>
    <label>Color
      <input type="color" name="color" value="{{ edit_type.color if edit_type else '#3b82f6' }}" style="width:60px;height:36px;padding:2px;">
    </label>
    <label>Location
      <input type="text" name="location" value="{{ edit_type.location if edit_type else '' }}" placeholder="e.g. 123 Main St or Zoom link">
    </label>
    <label>Show as
      <select name="show_as">
        <option value="busy" {% if not edit_type or edit_type.show_as == 'busy' %}selected{% endif %}>Busy</option>
        <option value="free" {% if edit_type and edit_type.show_as == 'free' %}selected{% endif %}>Free</option>
      </select>
    </label>
    <label>Visibility
      <select name="visibility">
        <option value="default" {% if not edit_type or edit_type.visibility == 'default' %}selected{% endif %}>Default (calendar setting)</option>
        <option value="public" {% if edit_type and edit_type.visibility == 'public' %}selected{% endif %}>Public</option>
        <option value="private" {% if edit_type and edit_type.visibility == 'private' %}selected{% endif %}>Private</option>
      </select>
    </label>
    <label>My Calendar Event Title
      <input type="text" name="owner_event_title"
             value="{{ edit_type.owner_event_title if edit_type else '' }}"
             placeholder="e.g. Showing â€” 123 Main St (leave blank for default)">
    </label>
    <label>Guest Confirmation Title
      <input type="text" name="guest_event_title"
             value="{{ edit_type.guest_event_title if edit_type else '' }}"
             placeholder="e.g. Your Home Tour (leave blank to use appointment type name)">
    </label>

    <hr style="margin:1rem 0;border:none;border-top:1px solid #e2e8f0;">
    <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
      <input type="checkbox" name="requires_drive_time" value="true"
             {% if edit_type and edit_type.requires_drive_time %}checked{% endif %}
             style="width:auto;">
      Calculate drive time to this location before each appointment
    </label>
    <small style="color:#64748b;margin-top:-.5rem;">
      Requires a physical location above and GOOGLE_MAPS_API_KEY configured in the environment.
    </small>

    <hr style="margin:1rem 0;border:none;border-top:1px solid #e2e8f0;">
    <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
      <input type="checkbox" name="calendar_window_enabled" value="true"
             id="cal_window_check"
             {% if edit_type and edit_type.calendar_window_enabled %}checked{% endif %}
             style="width:auto;"
             onchange="document.getElementById('cal_window_fields').style.display=this.checked?'block':'none'">
      Only allow bookings during specific Google Calendar events
    </label>
    <div id="cal_window_fields" style="display:{% if edit_type and edit_type.calendar_window_enabled %}block{% else %}none{% endif %};">
      <label>Event Title (exact match, case-insensitive)
        <input type="text" name="calendar_window_title"
               value="{{ edit_type.calendar_window_title if edit_type else '' }}"
               placeholder="e.g. POSSIBLE RENTAL SHOWINGS">
      </label>
      <label>Calendar ID (leave blank to use same calendar as booking)
        <input type="text" name="calendar_window_calendar_id"
               value="{{ edit_type.calendar_window_calendar_id if edit_type else '' }}"
               placeholder="e.g. primary or user@gmail.com">
      </label>
    </div>

    <div style="display:flex;gap:.75rem;margin-top:.25rem;">
      <button type="submit" class="btn btn-primary">{% if edit_type %}Save Changes{% else %}Create Type{% endif %}</button>
      {% if edit_type %}<a href="/admin/appointment-types" class="btn btn-secondary">Cancel</a>{% endif %}
    </div>
  </form>
</div>
{% endblock %}
