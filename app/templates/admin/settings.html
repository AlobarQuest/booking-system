{% extends "admin_base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<h1>Settings</h1>

<div class="card" style="cursor:default;max-width:520px;margin-bottom:2rem;">
  <h2 style="margin-bottom:1rem;">General</h2>
  <form method="post" action="/admin/settings">
    <label>Your Name (used in confirmation emails)
      <input type="text" name="owner_name" value="{{ owner_name }}">
    </label>
    <label>Notification Email (your address for new booking alerts)
      <input type="email" name="notify_email" value="{{ notify_email }}">
    </label>
    <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
      <input type="checkbox" name="notifications_enabled" value="true"
             {% if notifications_enabled %}checked{% endif %}
             style="width:auto;">
      Send email notifications
    </label>
    <label>Timezone
      <input type="text" name="timezone" value="{{ timezone }}" placeholder="America/New_York">
    </label>
    <label>Home Address (used for drive time calculation)
      <input type="text" name="home_address" value="{{ home_address }}"
             placeholder="e.g. 123 Main St, Atlanta, GA 30301">
    </label>
    <button type="submit" class="btn btn-primary">Save Settings</button>
  </form>
</div>

<div class="card" style="cursor:default;max-width:520px;margin-bottom:2rem;">
  <h2 style="margin-bottom:1rem;">Change Admin Password</h2>
  <form method="post" action="/admin/settings/password">
    <label>New Password
      <input type="password" name="password" minlength="8" required>
    </label>
    <label>Confirm
      <input type="password" name="confirm" required>
    </label>
    <button type="submit" class="btn btn-secondary">Change Password</button>
  </form>
</div>

<div class="card" style="cursor:default;max-width:520px;">
  <h2 style="margin-bottom:.75rem;">Google Calendar</h2>
  {% if google_authorized %}
  <p style="color:#059669;margin-bottom:.75rem;">&#10003; Connected</p>
  {% else %}
  <p style="color:#dc2626;margin-bottom:.75rem;">Not connected â€” calendar availability and event creation will be skipped.</p>
  {% endif %}
  <a href="/admin/google/authorize" class="btn btn-secondary">
    {% if google_authorized %}Re-authorize Google Calendar{% else %}Connect Google Calendar{% endif %}
  </a>
</div>

<div class="card" style="cursor:default;max-width:520px;margin-top:2rem;">
  <h2 style="margin-bottom:.75rem;">Conflict Calendars</h2>
  <p style="color:#64748b;font-size:.875rem;margin-bottom:1rem;">
    These calendars are checked for busy times when computing available slots.
    Supports Google Calendar IDs and webcal:// ICS feed URLs.
  </p>

  {% if conflict_cals %}
  <table style="margin-bottom:1rem;">
    <thead><tr><th>Name</th><th>Type</th><th>ID / URL</th><th></th></tr></thead>
    <tbody>
    {% for i, c in conflict_cals | enumerate %}
    <tr>
      <td>{{ c.name }}</td>
      <td>{{ c.type }}</td>
      <td style="font-size:.8rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ c.id }}</td>
      <td>
        <form method="post" action="/admin/settings/conflict-calendars/{{ i }}/delete">
          <button class="btn btn-danger" style="font-size:.8rem;padding:.3rem .6rem;">Remove</button>
        </form>
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p style="color:#64748b;font-size:.875rem;margin-bottom:1rem;">No conflict calendars added yet.</p>
  {% endif %}

  <form method="post" action="/admin/settings/conflict-calendars" style="margin-top:.5rem;">
    <label>Type
      <select name="cal_type">
        <option value="google">Google Calendar</option>
        <option value="webcal">webcal / ICS URL</option>
      </select>
    </label>
    <label>Calendar ID or URL
      <input type="text" name="cal_id"
             placeholder="e.g. primary, user@gmail.com, or webcal://...">
    </label>
    <label>Display Name (optional)
      <input type="text" name="cal_name" placeholder="e.g. ShowingTime">
    </label>
    <button type="submit" class="btn btn-secondary" style="margin-top:.25rem;">Add Calendar</button>
  </form>
</div>

<div class="card" style="cursor:default;max-width:640px;margin-top:2rem;">
  <h2 style="margin-bottom:.75rem;">Email Templates</h2>
  <p style="color:#64748b;font-size:.875rem;margin-bottom:1.5rem;">
    HTML email templates. Leave blank to use the built-in default.
  </p>
  <form method="post" action="/admin/settings/email-templates">

    <label>Guest Booking Confirmation
      <textarea name="email_guest_confirmation" rows="8"
                style="font-family:monospace;font-size:.8rem;">{{ email_guest_confirmation }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{appt_type}</code> <code>{date_time}</code>
      <code>{owner_name}</code> <code>{custom_fields}</code>
    </small>

    <label>Guest Cancellation Notice
      <textarea name="email_guest_cancellation" rows="6"
                style="font-family:monospace;font-size:.8rem;">{{ email_guest_cancellation }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{appt_type}</code> <code>{date_time}</code>
    </small>

    <label>Admin New-Booking Alert
      <textarea name="email_admin_alert" rows="8"
                style="font-family:monospace;font-size:.8rem;">{{ email_admin_alert }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{guest_email}</code> <code>{guest_phone}</code>
      <code>{appt_type}</code> <code>{date_time}</code> <code>{notes}</code>
      <code>{custom_fields}</code>
    </small>

    <button type="submit" class="btn btn-primary">Save Templates</button>
  </form>
</div>
{% endblock %}
