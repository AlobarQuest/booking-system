# Issues #6 & #7 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add photo upload, listing URL, rental requirements modal, calendar notification toggle to appointment types; make all three email templates editable in admin.

**Architecture:** New columns on `appointment_types` via existing PRAGMA migration pattern. Photos stored on the Docker volume at `/data/uploads/` (configurable via `UPLOAD_DIR` env var), served via a new `GET /uploads/{filename}` route. Email templates stored as `Settings` keys, passed as strings to `email.py` functions. Rental requirements stored as JSON array (same pattern as `custom_fields`). Calendar reminders controlled by a `disable_reminders` bool on `CalendarService.create_event()`.

**Tech Stack:** FastAPI, SQLAlchemy, SQLite, Jinja2, HTMX, pytest, Python 3.12

---

### Task 1: Data model — 4 new columns + rental_requirements property

**Files:**
- Modify: `app/models.py`
- Modify: `app/database.py`
- Modify: `app/config.py`
- Test: `tests/test_models.py`

**Step 1: Write the failing tests**

```python
# tests/test_models.py
import json
import pytest
from sqlalchemy import create_engine, inspect
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from app.database import Base, init_db
from app.models import AppointmentType


@pytest.fixture
def db_engine(tmp_path, monkeypatch):
    monkeypatch.setenv("DATABASE_URL", "sqlite:///:memory:")
    monkeypatch.setenv("UPLOAD_DIR", str(tmp_path / "uploads"))
    from app.config import get_settings
    get_settings.cache_clear()
    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    return engine


def test_appointment_type_new_columns(db_engine):
    cols = {c["name"] for c in inspect(db_engine).get_columns("appointment_types")}
    assert "photo_filename" in cols
    assert "listing_url" in cols
    assert "rental_requirements" in cols
    assert "owner_reminders_enabled" in cols


def test_rental_requirements_property():
    t = AppointmentType(name="Test", duration_minutes=30)
    assert t.rental_requirements == []
    t.rental_requirements = ["No pets", "Income 3x rent"]
    assert json.loads(t._rental_requirements) == ["No pets", "Income 3x rent"]
    assert t.rental_requirements == ["No pets", "Income 3x rent"]


def test_rental_requirements_defaults_empty():
    t = AppointmentType(name="Test", duration_minutes=30)
    assert t.rental_requirements == []
    assert t.photo_filename == ""
    assert t.listing_url == ""
    assert t.owner_reminders_enabled is False
```

**Step 2: Run tests to verify they fail**

```bash
cd /home/devon/Projects/BookingAssistant
python3 -m pytest tests/test_models.py -v
```
Expected: FAIL — `AppointmentType` missing attributes.

**Step 3: Add columns to `app/models.py`**

In `app/models.py`, add these four fields to `AppointmentType` after the `calendar_window_calendar_id` line:

```python
    photo_filename: Mapped[str] = mapped_column(Text, default="")
    listing_url: Mapped[str] = mapped_column(Text, default="")
    _rental_requirements: Mapped[str] = mapped_column("rental_requirements", Text, default="[]")
    owner_reminders_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
```

Add the property after the `custom_fields` property:

```python
    @property
    def rental_requirements(self) -> list:
        return json.loads(self._rental_requirements)

    @rental_requirements.setter
    def rental_requirements(self, value: list):
        self._rental_requirements = json.dumps(value)
```

**Step 4: Add migrations to `app/database.py`**

In `init_db()`, extend the migration list with the four new columns:

```python
        for col, definition in [
            ("location", "TEXT NOT NULL DEFAULT ''"),
            ("show_as", "VARCHAR(20) NOT NULL DEFAULT 'busy'"),
            ("visibility", "VARCHAR(20) NOT NULL DEFAULT 'default'"),
            ("owner_event_title", "TEXT NOT NULL DEFAULT ''"),
            ("guest_event_title", "TEXT NOT NULL DEFAULT ''"),
            ("requires_drive_time", "BOOLEAN NOT NULL DEFAULT 0"),
            ("calendar_window_enabled", "BOOLEAN NOT NULL DEFAULT 0"),
            ("calendar_window_title", "TEXT NOT NULL DEFAULT ''"),
            ("calendar_window_calendar_id", "TEXT NOT NULL DEFAULT ''"),
            # New in issues #6/#7:
            ("photo_filename", "TEXT NOT NULL DEFAULT ''"),
            ("listing_url", "TEXT NOT NULL DEFAULT ''"),
            ("rental_requirements", "TEXT NOT NULL DEFAULT '[]'"),
            ("owner_reminders_enabled", "BOOLEAN NOT NULL DEFAULT 0"),
        ]:
```

**Step 5: Add `upload_dir` to `app/config.py`**

```python
class Settings(BaseSettings):
    database_url: str = "sqlite:///./booking.db"
    secret_key: str = "change-me-in-production"
    google_client_id: str = ""
    google_client_secret: str = ""
    google_redirect_uri: str = "http://localhost:8000/admin/google/callback"
    google_maps_api_key: str = ""
    resend_api_key: str = ""
    from_email: str = "noreply@example.com"
    timezone: str = "America/New_York"
    upload_dir: str = "/data/uploads"          # NEW
```

**Step 6: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_models.py -v
```
Expected: PASS (3 tests).

**Step 7: Run full test suite to confirm nothing broke**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all existing tests still PASS.

**Step 8: Commit**

```bash
git add app/models.py app/database.py app/config.py tests/test_models.py
git commit -m "feat: add photo_filename, listing_url, rental_requirements, owner_reminders_enabled to AppointmentType"
```

---

### Task 2: Photo serving — GET /uploads/{filename} route

**Files:**
- Modify: `app/main.py` (create uploads dir in lifespan)
- Modify: `app/routers/booking.py` (add route)
- Test: `tests/test_uploads.py`

**Step 1: Write the failing tests**

```python
# tests/test_uploads.py
import os
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from app.database import Base, get_db
from app.main import app


@pytest.fixture
def upload_client(tmp_path, monkeypatch):
    monkeypatch.setenv("UPLOAD_DIR", str(tmp_path / "uploads"))
    os.makedirs(tmp_path / "uploads", exist_ok=True)
    from app.config import get_settings
    get_settings.cache_clear()

    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    TestSession = sessionmaker(bind=engine)

    def override_get_db():
        db = TestSession()
        try:
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db
    with TestClient(app, raise_server_exceptions=True) as c:
        yield c, tmp_path
    app.dependency_overrides.clear()
    get_settings.cache_clear()


def test_upload_missing_file_returns_404(upload_client):
    client, _ = upload_client
    resp = client.get("/uploads/nonexistent.jpg")
    assert resp.status_code == 404


def test_upload_serves_existing_file(upload_client):
    client, tmp_path = upload_client
    upload_dir = tmp_path / "uploads"
    (upload_dir / "test.jpg").write_bytes(b"fake image data")
    resp = client.get("/uploads/test.jpg")
    assert resp.status_code == 200
    assert resp.content == b"fake image data"


def test_upload_path_traversal_rejected(upload_client):
    client, _ = upload_client
    resp = client.get("/uploads/../app/config.py")
    assert resp.status_code in (400, 404)
```

**Step 2: Run tests to verify they fail**

```bash
python3 -m pytest tests/test_uploads.py -v
```
Expected: FAIL — route doesn't exist yet.

**Step 3: Update lifespan in `app/main.py`**

Replace:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    init_db()
    yield
```

With:
```python
import os

@asynccontextmanager
async def lifespan(app: FastAPI):
    init_db()
    os.makedirs(get_settings().upload_dir, exist_ok=True)
    yield
```

**Step 4: Add the route to `app/routers/booking.py`**

Add at the top of the file with the other imports:
```python
import os
from fastapi.responses import FileResponse
```

Add this route before the `root` route:
```python
@router.get("/uploads/{filename}")
def serve_upload(filename: str):
    # Prevent path traversal
    if "/" in filename or "\\" in filename or filename.startswith("."):
        from fastapi import HTTPException
        raise HTTPException(status_code=400, detail="Invalid filename")
    settings = get_settings()
    path = os.path.join(settings.upload_dir, filename)
    if not os.path.isfile(path):
        from fastapi import HTTPException
        raise HTTPException(status_code=404, detail="File not found")
    return FileResponse(path)
```

**Step 5: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_uploads.py -v
```
Expected: PASS (3 tests).

**Step 6: Run full test suite**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all PASS.

**Step 7: Commit**

```bash
git add app/main.py app/routers/booking.py tests/test_uploads.py
git commit -m "feat: add GET /uploads/{filename} route with path traversal protection"
```

---

### Task 3: Admin — photo upload, listing URL, reminders toggle, rental requirements

**Files:**
- Modify: `app/routers/admin.py`
- Modify: `app/templates/admin/appointment_types.html`
- Test: `tests/test_admin_appt_types.py`

**Step 1: Write the failing tests**

```python
# tests/test_admin_appt_types.py
import io
import json
import os
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from app.database import Base, get_db
from app.main import app
from app.models import AppointmentType


@pytest.fixture
def admin_client(tmp_path, monkeypatch):
    monkeypatch.setenv("UPLOAD_DIR", str(tmp_path / "uploads"))
    os.makedirs(tmp_path / "uploads", exist_ok=True)
    from app.config import get_settings
    get_settings.cache_clear()

    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    TestSession = sessionmaker(bind=engine)

    def override_get_db():
        db = TestSession()
        try:
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db

    with TestClient(app, raise_server_exceptions=True) as c:
        c.get("/admin/login")  # Initialize session
        # Set admin session directly
        with c as session_client:
            session_client.cookies.set("session", "")
        # Use session trick: patch require_admin
        from app import dependencies
        monkeypatch.setattr(dependencies, "require_admin", lambda request: True)
        yield c, TestSession, tmp_path

    app.dependency_overrides.clear()
    get_settings.cache_clear()


def test_create_appt_type_with_photo(admin_client):
    client, SessionFactory, tmp_path = admin_client
    resp = client.post(
        "/admin/appointment-types",
        files={"photo": ("house.jpg", io.BytesIO(b"img data"), "image/jpeg")},
        data={
            "name": "Rental Showing",
            "duration_minutes": "30",
            "listing_url": "https://example.com/listing",
            "rental_requirements_json": json.dumps(["No pets", "Income 3x rent"]),
            "owner_reminders_enabled": "true",
        },
    )
    assert resp.status_code == 302
    db = SessionFactory()
    t = db.query(AppointmentType).filter_by(name="Rental Showing").first()
    assert t is not None
    assert t.photo_filename != ""
    assert t.listing_url == "https://example.com/listing"
    assert t.rental_requirements == ["No pets", "Income 3x rent"]
    assert t.owner_reminders_enabled is True
    # Verify file was written
    assert os.path.isfile(os.path.join(str(tmp_path / "uploads"), t.photo_filename))
    db.close()


def test_update_appt_type_removes_old_photo(admin_client):
    client, SessionFactory, tmp_path = admin_client
    upload_dir = str(tmp_path / "uploads")
    # Create initial type with a pre-existing photo file
    db = SessionFactory()
    t = AppointmentType(name="Showing", duration_minutes=30, photo_filename="old.jpg")
    db.add(t)
    db.commit()
    type_id = t.id
    # Write the old photo file
    with open(os.path.join(upload_dir, "old.jpg"), "wb") as f:
        f.write(b"old")
    db.close()

    resp = client.post(
        f"/admin/appointment-types/{type_id}",
        files={"photo": ("new.jpg", io.BytesIO(b"new img"), "image/jpeg")},
        data={"name": "Showing", "duration_minutes": "30"},
    )
    assert resp.status_code == 302
    # Old file deleted
    assert not os.path.isfile(os.path.join(upload_dir, "old.jpg"))
    # New file exists
    db = SessionFactory()
    t = db.query(AppointmentType).filter_by(id=type_id).first()
    assert t.photo_filename != "old.jpg"
    assert os.path.isfile(os.path.join(upload_dir, t.photo_filename))
    db.close()


def test_remove_photo_flag(admin_client):
    client, SessionFactory, tmp_path = admin_client
    upload_dir = str(tmp_path / "uploads")
    db = SessionFactory()
    t = AppointmentType(name="Showing2", duration_minutes=30, photo_filename="existing.jpg")
    db.add(t)
    db.commit()
    type_id = t.id
    with open(os.path.join(upload_dir, "existing.jpg"), "wb") as f:
        f.write(b"x")
    db.close()

    resp = client.post(
        f"/admin/appointment-types/{type_id}",
        data={"name": "Showing2", "duration_minutes": "30", "remove_photo": "true"},
    )
    assert resp.status_code == 302
    assert not os.path.isfile(os.path.join(upload_dir, "existing.jpg"))
    db = SessionFactory()
    t = db.query(AppointmentType).filter_by(id=type_id).first()
    assert t.photo_filename == ""
    db.close()
```

**Step 2: Run tests to verify they fail**

```bash
python3 -m pytest tests/test_admin_appt_types.py -v
```
Expected: FAIL.

**Step 3: Update `app/routers/admin.py`**

Add imports at top of admin.py:
```python
import json
import os
import uuid
from fastapi import File, UploadFile
```

Change `create_appt_type` from `def` to `async def` and add new parameters (add after `calendar_window_calendar_id`):

```python
@router.post("/appointment-types")
async def create_appt_type(
    request: Request,
    name: str = Form(...),
    description: str = Form(""),
    duration_minutes: int = Form(...),
    buffer_before_minutes: int = Form(0),
    buffer_after_minutes: int = Form(0),
    calendar_id: str = Form("primary"),
    color: str = Form("#3b82f6"),
    location: str = Form(""),
    show_as: str = Form("busy"),
    visibility: str = Form("default"),
    owner_event_title: str = Form(""),
    guest_event_title: str = Form(""),
    requires_drive_time: str = Form("false"),
    calendar_window_enabled: str = Form("false"),
    calendar_window_title: str = Form(""),
    calendar_window_calendar_id: str = Form(""),
    listing_url: str = Form(""),
    rental_requirements_json: str = Form("[]"),
    owner_reminders_enabled: str = Form("false"),
    photo: UploadFile | None = File(None),
    remove_photo: str = Form(""),
    db: Session = Depends(get_db),
    _=AuthDep,
):
    from app.config import get_settings as _get_settings
    t = AppointmentType(
        name=name, description=description, duration_minutes=duration_minutes,
        buffer_before_minutes=buffer_before_minutes, buffer_after_minutes=buffer_after_minutes,
        calendar_id=calendar_id, color=color, location=location, show_as=show_as,
        visibility=visibility, owner_event_title=owner_event_title, guest_event_title=guest_event_title,
        requires_drive_time=(requires_drive_time == "true"),
        calendar_window_enabled=(calendar_window_enabled == "true"),
        calendar_window_title=calendar_window_title,
        calendar_window_calendar_id=calendar_window_calendar_id,
        listing_url=listing_url,
        owner_reminders_enabled=(owner_reminders_enabled == "true"),
        active=True,
    )
    t.custom_fields = []
    try:
        t.rental_requirements = json.loads(rental_requirements_json)
    except (json.JSONDecodeError, ValueError):
        t.rental_requirements = []
    db.add(t)
    db.commit()
    db.refresh(t)
    # Handle photo upload
    if photo and photo.filename:
        ext = os.path.splitext(photo.filename)[1].lower() or ".jpg"
        filename = f"{uuid.uuid4().hex}{ext}"
        upload_dir = _get_settings().upload_dir
        os.makedirs(upload_dir, exist_ok=True)
        with open(os.path.join(upload_dir, filename), "wb") as f:
            f.write(await photo.read())
        t.photo_filename = filename
        db.commit()
    _flash(request, f"Created '{name}'.")
    return RedirectResponse("/admin/appointment-types", status_code=302)
```

Change `update_appt_type` from `def` to `async def` and add new parameters:

```python
@router.post("/appointment-types/{type_id}")
async def update_appt_type(
    request: Request, type_id: int,
    name: str = Form(...), description: str = Form(""),
    duration_minutes: int = Form(...), buffer_before_minutes: int = Form(0),
    buffer_after_minutes: int = Form(0), calendar_id: str = Form("primary"),
    color: str = Form("#3b82f6"), location: str = Form(""),
    show_as: str = Form("busy"), visibility: str = Form("default"),
    owner_event_title: str = Form(""),
    guest_event_title: str = Form(""),
    requires_drive_time: str = Form("false"),
    calendar_window_enabled: str = Form("false"),
    calendar_window_title: str = Form(""),
    calendar_window_calendar_id: str = Form(""),
    listing_url: str = Form(""),
    rental_requirements_json: str = Form("[]"),
    owner_reminders_enabled: str = Form("false"),
    photo: UploadFile | None = File(None),
    remove_photo: str = Form(""),
    db: Session = Depends(get_db), _=AuthDep,
):
    from app.config import get_settings as _get_settings
    t = db.query(AppointmentType).filter_by(id=type_id).first()
    if t:
        t.name = name; t.description = description; t.duration_minutes = duration_minutes
        t.buffer_before_minutes = buffer_before_minutes
        t.buffer_after_minutes = buffer_after_minutes
        t.calendar_id = calendar_id; t.color = color
        t.location = location; t.show_as = show_as; t.visibility = visibility
        t.owner_event_title = owner_event_title
        t.guest_event_title = guest_event_title
        t.requires_drive_time = (requires_drive_time == "true")
        t.calendar_window_enabled = (calendar_window_enabled == "true")
        t.calendar_window_title = calendar_window_title
        t.calendar_window_calendar_id = calendar_window_calendar_id
        t.listing_url = listing_url
        t.owner_reminders_enabled = (owner_reminders_enabled == "true")
        try:
            t.rental_requirements = json.loads(rental_requirements_json)
        except (json.JSONDecodeError, ValueError):
            t.rental_requirements = []
        upload_dir = _get_settings().upload_dir
        # Remove photo if flagged
        if remove_photo == "true" and t.photo_filename:
            old_path = os.path.join(upload_dir, t.photo_filename)
            if os.path.isfile(old_path):
                os.remove(old_path)
            t.photo_filename = ""
        # Upload new photo (replaces old one)
        elif photo and photo.filename:
            if t.photo_filename:
                old_path = os.path.join(upload_dir, t.photo_filename)
                if os.path.isfile(old_path):
                    os.remove(old_path)
            ext = os.path.splitext(photo.filename)[1].lower() or ".jpg"
            filename = f"{uuid.uuid4().hex}{ext}"
            os.makedirs(upload_dir, exist_ok=True)
            with open(os.path.join(upload_dir, filename), "wb") as f:
                f.write(await photo.read())
            t.photo_filename = filename
        db.commit()
        _flash(request, f"Updated '{name}'.")
    return RedirectResponse("/admin/appointment-types", status_code=302)
```

**Step 4: Update `app/templates/admin/appointment_types.html`**

Change the form tag to support file upload:
```html
<form method="post" action="..." style="margin-top:1rem;" enctype="multipart/form-data">
```

After the `guest_event_title` field, add the new fields section. Add before the drive time `<hr>`:

```html
    <label>Listing URL
      <input type="url" name="listing_url"
             value="{{ edit_type.listing_url if edit_type else '' }}"
             placeholder="https://example.com/listing-123">
    </label>

    <label>Property Photo
      {% if edit_type and edit_type.photo_filename %}
      <div style="margin-bottom:.5rem;">
        <img src="/uploads/{{ edit_type.photo_filename }}" alt="Current photo"
             style="width:170px;height:auto;border-radius:8px;border:1px solid #e2e8f0;">
        <br>
        <label style="flex-direction:row;align-items:center;gap:.5rem;margin-top:.5rem;cursor:pointer;">
          <input type="checkbox" name="remove_photo" value="true" style="width:auto;">
          Remove current photo
        </label>
      </div>
      {% endif %}
      <input type="file" name="photo" accept="image/*">
      <small style="color:#64748b;">Upload an MLS-size photo. Displayed at 170px wide on booking page.</small>
    </label>

    <hr style="margin:1rem 0;border:none;border-top:1px solid #e2e8f0;">
    <h3 style="font-size:.95rem;font-weight:600;margin-bottom:.75rem;">Rental Requirements</h3>
    <small style="color:#64748b;display:block;margin-bottom:.75rem;">
      Guests see these in a modal on the booking page. Leave all unchecked to hide the requirements button.
    </small>
    <input type="hidden" name="rental_requirements_json" id="req-json"
           value="{{ edit_type.rental_requirements | tojson if edit_type else '[]' }}">
    <div id="req-list" style="display:flex;flex-direction:column;gap:.4rem;">
      {% set predefined = [
        "No credit check required", "Income 3x monthly rent", "Valid government-issued ID",
        "Background check required", "No smoking", "No pets", "Renter's insurance required",
        "First month, last month, and security deposit", "References required",
        "Minimum 12-month lease"
      ] %}
      {% set existing_reqs = edit_type.rental_requirements if edit_type else [] %}
      {% for req in predefined %}
      <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
        <input type="checkbox" class="req-checkbox" value="{{ req }}"
               {% if req in existing_reqs %}checked{% endif %}
               style="width:auto;" onchange="updateReqJson()">
        {{ req }}
      </label>
      {% endfor %}
      {% for req in existing_reqs %}
      {% if req not in predefined %}
      <div class="custom-req-item" style="display:flex;align-items:center;gap:.5rem;">
        <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
          <input type="checkbox" class="req-checkbox" value="{{ req }}" checked
                 style="width:auto;" onchange="updateReqJson()">
          {{ req }}
        </label>
        <button type="button" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1rem;padding:0;"
                onclick="this.parentElement.remove();updateReqJson()">×</button>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    <div style="display:flex;gap:.5rem;margin-top:.75rem;">
      <input type="text" id="custom-req-input" placeholder="Add custom requirement..."
             style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addCustomReq();}">
      <button type="button" class="btn btn-secondary" onclick="addCustomReq()"
              style="white-space:nowrap;">+ Add</button>
    </div>
    <script>
    function updateReqJson() {
      const checked = [...document.querySelectorAll('.req-checkbox:checked')].map(cb => cb.value);
      document.getElementById('req-json').value = JSON.stringify(checked);
    }
    function addCustomReq() {
      const input = document.getElementById('custom-req-input');
      const val = input.value.trim();
      if (!val) return;
      const div = document.createElement('div');
      div.className = 'custom-req-item';
      div.style.cssText = 'display:flex;align-items:center;gap:.5rem;';
      div.innerHTML = `<label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;"><input type="checkbox" class="req-checkbox" value="${val.replace(/"/g,'&quot;')}" checked style="width:auto;" onchange="updateReqJson()"> ${val}</label> <button type="button" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1rem;padding:0;" onclick="this.parentElement.remove();updateReqJson()">×</button>`;
      document.getElementById('req-list').appendChild(div);
      input.value = '';
      updateReqJson();
    }
    // Sync JSON on page load (covers pre-checked predefined)
    updateReqJson();
    </script>
```

After the calendar window section, before the submit button div, add the reminders toggle:

```html
    <hr style="margin:1rem 0;border:none;border-top:1px solid #e2e8f0;">
    <label style="flex-direction:row;align-items:center;gap:.5rem;cursor:pointer;">
      <input type="checkbox" name="owner_reminders_enabled" value="true"
             {% if edit_type and edit_type.owner_reminders_enabled %}checked{% endif %}
             style="width:auto;">
      Send calendar reminders on my event
    </label>
    <small style="color:#64748b;margin-top:-.5rem;">
      When unchecked, your calendar event is created with no reminders/notifications.
    </small>
```

**Step 5: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_admin_appt_types.py -v
```
Expected: PASS (3 tests).

**Step 6: Run full test suite**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all PASS.

**Step 7: Commit**

```bash
git add app/routers/admin.py app/templates/admin/appointment_types.html tests/test_admin_appt_types.py
git commit -m "feat: add photo upload, listing URL, rental requirements, reminders toggle to appointment type admin"
```

---

### Task 4: Booking page — photo, listing link, requirements modal

**Files:**
- Modify: `app/templates/booking/index.html`
- Modify: `app/static/css/style.css`
- Test: `tests/test_booking_page.py`

**Step 1: Write the failing tests**

```python
# tests/test_booking_page.py
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from app.database import Base, get_db
from app.main import app
from app.models import AppointmentType


@pytest.fixture
def booking_client():
    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    TestSession = sessionmaker(bind=engine)

    def override_get_db():
        db = TestSession()
        try:
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db

    db = TestSession()
    t = AppointmentType(
        name="Rental Showing",
        duration_minutes=30,
        active=True,
        photo_filename="house.jpg",
        listing_url="https://example.com/listing",
    )
    t.rental_requirements = ["No pets", "Income 3x rent"]
    db.add(t)
    db.commit()
    db.close()

    with TestClient(app, raise_server_exceptions=True) as c:
        yield c

    app.dependency_overrides.clear()


def test_booking_page_shows_photo(booking_client):
    resp = booking_client.get("/")
    assert resp.status_code == 200
    assert '/uploads/house.jpg' in resp.text


def test_booking_page_shows_listing_link(booking_client):
    resp = booking_client.get("/")
    assert 'https://example.com/listing' in resp.text
    assert 'View Listing' in resp.text


def test_booking_page_shows_requirements_button(booking_client):
    resp = booking_client.get("/")
    assert 'View Requirements' in resp.text
    assert 'No pets' in resp.text


def test_booking_page_no_requirements_no_button():
    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    Base.metadata.create_all(engine)
    TestSession = sessionmaker(bind=engine)

    def override_get_db():
        db = TestSession()
        try:
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db
    db = TestSession()
    t = AppointmentType(name="No Reqs", duration_minutes=30, active=True)
    db.add(t)
    db.commit()
    db.close()

    with TestClient(app) as c:
        resp = c.get("/")
        assert 'View Requirements' not in resp.text

    app.dependency_overrides.clear()
```

**Step 2: Run tests to verify they fail**

```bash
python3 -m pytest tests/test_booking_page.py -v
```
Expected: FAIL.

**Step 3: Update `app/templates/booking/index.html`**

Replace the `<div id="type-selection">` block with:

```html
<div id="type-selection">
  {% for appt in appointment_types %}
  <div class="card" onclick="selectType({{ appt.id }}, this)">
    {% if appt.photo_filename %}
    <img src="/uploads/{{ appt.photo_filename }}" alt="{{ appt.name }}"
         style="width:170px;height:auto;border-radius:8px;margin-bottom:.75rem;display:block;">
    {% endif %}
    <h3>{{ appt.name }}</h3>
    <div class="card-meta">
      {% if appt.description %}<span>{{ appt.description }}</span>{% endif %}
      <span class="card-duration">&#9679; {{ appt.duration_minutes }} min</span>
    </div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem;" onclick="event.stopPropagation()">
      {% if appt.listing_url %}
      <a href="{{ appt.listing_url }}" target="_blank" rel="noopener noreferrer"
         class="btn btn-secondary" style="font-size:.8rem;padding:.3rem .75rem;">View Listing</a>
      {% endif %}
      {% if appt.rental_requirements %}
      <button type="button" class="btn btn-secondary"
              style="font-size:.8rem;padding:.3rem .75rem;"
              data-requirements="{{ appt.rental_requirements | tojson }}"
              onclick="showRequirements(this)">View Requirements</button>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Requirements modal -->
<div id="req-modal"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000;"
     onclick="if(event.target===this)closeReqModal()">
  <div style="background:#fff;border-radius:12px;padding:2rem;max-width:420px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);">
    <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1rem;">Rental Requirements</h3>
    <ul id="req-modal-list" style="padding-left:1.5rem;line-height:2.2;color:#334155;"></ul>
    <button class="btn btn-secondary" style="margin-top:1.5rem;width:100%;"
            onclick="closeReqModal()">Close</button>
  </div>
</div>
```

Update the `<script>` block to add the modal functions:

```html
<script>
function selectType(id, el) {
  document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('type_id_input').value = id;
  document.getElementById('date-picker-area').style.display = 'block';
  document.getElementById('slots-area').innerHTML = '';
  document.getElementById('booking-form-area').innerHTML = '';
  document.getElementById('date-input').value = '';
  document.getElementById('step2').classList.add('active');
}
function selectSlot(el) {
  document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('step3').classList.add('active');
}
function showRequirements(btn) {
  const reqs = JSON.parse(btn.dataset.requirements);
  document.getElementById('req-modal-list').innerHTML =
    reqs.map(r => `<li>${r}</li>`).join('');
  document.getElementById('req-modal').style.display = 'flex';
}
function closeReqModal() {
  document.getElementById('req-modal').style.display = 'none';
}
</script>
```

**Step 4: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_booking_page.py -v
```
Expected: PASS (4 tests).

**Step 5: Run full test suite**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all PASS.

**Step 6: Commit**

```bash
git add app/templates/booking/index.html tests/test_booking_page.py
git commit -m "feat: show photo, listing link, and requirements modal on booking page"
```

---

### Task 5: Email templates — admin editor + DB-driven rendering

**Files:**
- Modify: `app/services/email.py`
- Modify: `app/routers/admin.py` (add email template save route)
- Modify: `app/routers/booking.py` (pass templates to email functions)
- Modify: `app/templates/admin/settings.html`
- Test: `tests/test_email_templates.py`

**Step 1: Write the failing tests**

```python
# tests/test_email_templates.py
import pytest
from unittest.mock import patch, MagicMock
from datetime import datetime
from app.services.email import (
    send_guest_confirmation,
    send_admin_alert,
    send_cancellation_notice,
    _GUEST_CONFIRMATION_DEFAULT,
    _ADMIN_ALERT_DEFAULT,
    _CANCELLATION_DEFAULT,
)


def test_send_guest_confirmation_uses_custom_template():
    custom_tpl = "<p>Hi {guest_name}, your {appt_type} on {date_time} is set. — {owner_name}</p>"
    captured = {}
    with patch("resend.Emails.send", side_effect=lambda x: captured.update(x)):
        send_guest_confirmation(
            api_key="key",
            from_email="from@test.com",
            guest_email="guest@test.com",
            guest_name="Alice",
            appt_type_name="Rental Showing",
            start_dt=datetime(2026, 3, 1, 10, 0),
            end_dt=datetime(2026, 3, 1, 10, 30),
            custom_responses={},
            owner_name="Devon",
            template=custom_tpl,
        )
    assert "Alice" in captured["html"]
    assert "Rental Showing" in captured["html"]
    assert "Devon" in captured["html"]


def test_send_guest_confirmation_falls_back_to_default():
    captured = {}
    with patch("resend.Emails.send", side_effect=lambda x: captured.update(x)):
        send_guest_confirmation(
            api_key="key",
            from_email="from@test.com",
            guest_email="guest@test.com",
            guest_name="Bob",
            appt_type_name="Showing",
            start_dt=datetime(2026, 3, 1, 10, 0),
            end_dt=datetime(2026, 3, 1, 10, 30),
            custom_responses={},
            owner_name="Devon",
            template="",  # empty → use default
        )
    assert "Bob" in captured["html"]
    assert "confirmed" in captured["html"].lower()


def test_send_admin_alert_uses_custom_template():
    custom_tpl = "<p>New: {guest_name} ({guest_email}) for {appt_type} on {date_time}</p>"
    captured = {}
    with patch("resend.Emails.send", side_effect=lambda x: captured.update(x)):
        send_admin_alert(
            api_key="key",
            from_email="from@test.com",
            notify_email="admin@test.com",
            guest_name="Carol",
            guest_email="carol@test.com",
            guest_phone="",
            appt_type_name="Showing",
            start_dt=datetime(2026, 3, 1, 10, 0),
            notes="",
            custom_responses={},
            template=custom_tpl,
        )
    assert "Carol" in captured["html"]
    assert "carol@test.com" in captured["html"]


def test_send_cancellation_uses_custom_template():
    custom_tpl = "<p>Cancelled: {guest_name} — {appt_type} — {date_time}</p>"
    captured = {}
    with patch("resend.Emails.send", side_effect=lambda x: captured.update(x)):
        send_cancellation_notice(
            api_key="key",
            from_email="from@test.com",
            guest_email="guest@test.com",
            guest_name="Dave",
            appt_type_name="Showing",
            start_dt=datetime(2026, 3, 1, 10, 0),
            template=custom_tpl,
        )
    assert "Dave" in captured["html"]
    assert "Cancelled" in captured["html"]
```

**Step 2: Run tests to verify they fail**

```bash
python3 -m pytest tests/test_email_templates.py -v
```
Expected: FAIL — `template` parameter doesn't exist yet, no default constants exported.

**Step 3: Rewrite `app/services/email.py`**

```python
import resend
from datetime import datetime


def _format_dt(dt: datetime) -> str:
    return dt.strftime("%A, %B %-d, %Y at %-I:%M %p UTC")


_GUEST_CONFIRMATION_DEFAULT = """\
<h2>Your appointment is confirmed</h2>
<p>Hi {guest_name},</p>
<p>Your <strong>{appt_type}</strong> is confirmed:</p>
<p><strong>Date/Time:</strong> {date_time}</p>
{custom_fields}
<p>If you need to cancel, please reply to this email.</p>
<p>— {owner_name}</p>"""

_ADMIN_ALERT_DEFAULT = """\
<h2>New Booking: {guest_name}</h2>
<p><strong>Type:</strong> {appt_type}</p>
<p><strong>Date/Time:</strong> {date_time}</p>
<p><strong>Guest:</strong> {guest_name}</p>
<p><strong>Email:</strong> {guest_email}</p>
<p><strong>Phone:</strong> {guest_phone}</p>
{custom_fields}
<p><strong>Notes:</strong> {notes}</p>
<p><a href="/admin/bookings">View in admin panel</a></p>"""

_CANCELLATION_DEFAULT = """\
<h2>Appointment Cancelled</h2>
<p>Hi {guest_name},</p>
<p>Your <strong>{appt_type}</strong> on {date_time} has been cancelled.</p>
<p>Please reach out to reschedule.</p>"""


def send_guest_confirmation(
    api_key: str,
    from_email: str,
    guest_email: str,
    guest_name: str,
    appt_type_name: str,
    start_dt: datetime,
    end_dt: datetime,
    custom_responses: dict,
    owner_name: str,
    template: str = "",
):
    resend.api_key = api_key
    custom_html = "".join(
        f"<p><strong>{k}:</strong> {v}</p>"
        for k, v in custom_responses.items() if v
    )
    html = (template or _GUEST_CONFIRMATION_DEFAULT).format(
        guest_name=guest_name,
        appt_type=appt_type_name,
        date_time=_format_dt(start_dt),
        owner_name=owner_name,
        custom_fields=custom_html,
    )
    resend.Emails.send({
        "from": from_email,
        "to": [guest_email],
        "subject": f"Your {appt_type_name} is confirmed — {start_dt.strftime('%b %-d')}",
        "html": html,
    })


def send_admin_alert(
    api_key: str,
    from_email: str,
    notify_email: str,
    guest_name: str,
    guest_email: str,
    guest_phone: str,
    appt_type_name: str,
    start_dt: datetime,
    notes: str,
    custom_responses: dict,
    template: str = "",
):
    resend.api_key = api_key
    custom_html = "".join(
        f"<p><strong>{k}:</strong> {v}</p>"
        for k, v in custom_responses.items() if v
    )
    html = (template or _ADMIN_ALERT_DEFAULT).format(
        guest_name=guest_name,
        guest_email=guest_email,
        guest_phone=guest_phone or "not provided",
        appt_type=appt_type_name,
        date_time=_format_dt(start_dt),
        notes=notes or "none",
        custom_fields=custom_html,
    )
    resend.Emails.send({
        "from": from_email,
        "to": [notify_email],
        "subject": f"New booking: {guest_name} — {appt_type_name} on {start_dt.strftime('%b %-d')}",
        "html": html,
    })


def send_cancellation_notice(
    api_key: str,
    from_email: str,
    guest_email: str,
    guest_name: str,
    appt_type_name: str,
    start_dt: datetime,
    template: str = "",
):
    resend.api_key = api_key
    html = (template or _CANCELLATION_DEFAULT).format(
        guest_name=guest_name,
        appt_type=appt_type_name,
        date_time=_format_dt(start_dt),
    )
    resend.Emails.send({
        "from": from_email,
        "to": [guest_email],
        "subject": f"Your {appt_type_name} on {start_dt.strftime('%b %-d')} has been cancelled",
        "html": html,
    })
```

**Step 4: Update `app/routers/booking.py` to pass templates**

In the `submit_booking` handler, find where `send_guest_confirmation` and `send_admin_alert` are called and add template fetching:

```python
    if notifications_enabled and settings.resend_api_key:
        from app.services.email import send_guest_confirmation, send_admin_alert
        try:
            send_guest_confirmation(
                api_key=settings.resend_api_key,
                from_email=settings.from_email,
                guest_email=guest_email,
                guest_name=guest_name,
                appt_type_name=guest_appt_name,
                start_dt=start_dt,
                end_dt=end_dt,
                custom_responses=custom_responses,
                owner_name=owner_name,
                template=get_setting(db, "email_guest_confirmation", ""),
            )
        except Exception:
            pass
        if notify_email:
            try:
                send_admin_alert(
                    api_key=settings.resend_api_key,
                    from_email=settings.from_email,
                    notify_email=notify_email,
                    guest_name=guest_name,
                    guest_email=guest_email,
                    guest_phone=guest_phone,
                    appt_type_name=guest_appt_name,
                    start_dt=start_dt,
                    notes=notes,
                    custom_responses=custom_responses,
                    template=get_setting(db, "email_admin_alert", ""),
                )
            except Exception:
                pass
```

Find where `send_cancellation_notice` is called (in the admin bookings cancel route) and update it similarly. In `app/routers/admin.py`, find the cancellation call and add:

```python
from app.services.email import send_cancellation_notice
send_cancellation_notice(
    ...
    template=get_setting(db, "email_guest_cancellation", ""),
)
```

**Step 5: Add email template save route to `app/routers/admin.py`**

```python
@router.post("/settings/email-templates")
def save_email_templates(
    request: Request,
    email_guest_confirmation: str = Form(""),
    email_admin_alert: str = Form(""),
    email_guest_cancellation: str = Form(""),
    db: Session = Depends(get_db),
    _=AuthDep,
):
    set_setting(db, "email_guest_confirmation", email_guest_confirmation)
    set_setting(db, "email_admin_alert", email_admin_alert)
    set_setting(db, "email_guest_cancellation", email_guest_cancellation)
    _flash(request, "Email templates saved.")
    return RedirectResponse("/admin/settings", status_code=302)
```

**Step 6: Update admin settings route to pass email templates to template**

In `app/routers/admin.py`, find the `settings_page` GET handler and add:

```python
    return templates.TemplateResponse("admin/settings.html", {
        ...,
        "email_guest_confirmation": get_setting(db, "email_guest_confirmation", ""),
        "email_admin_alert": get_setting(db, "email_admin_alert", ""),
        "email_guest_cancellation": get_setting(db, "email_guest_cancellation", ""),
    })
```

**Step 7: Add email templates section to `app/templates/admin/settings.html`**

Add a new card section after the conflict calendars card:

```html
<div class="card" style="cursor:default;max-width:640px;margin-top:2rem;">
  <h2 style="margin-bottom:.75rem;">Email Templates</h2>
  <p style="color:#64748b;font-size:.875rem;margin-bottom:1.5rem;">
    HTML email templates. Leave blank to use the built-in default.
  </p>
  <form method="post" action="/admin/settings/email-templates">

    <label>Guest Booking Confirmation
      <textarea name="email_guest_confirmation" rows="8"
                style="font-family:monospace;font-size:.8rem;">{{ email_guest_confirmation }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{appt_type}</code> <code>{date_time}</code>
      <code>{owner_name}</code> <code>{custom_fields}</code>
    </small>

    <label>Guest Cancellation Notice
      <textarea name="email_guest_cancellation" rows="6"
                style="font-family:monospace;font-size:.8rem;">{{ email_guest_cancellation }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{appt_type}</code> <code>{date_time}</code>
    </small>

    <label>Admin New-Booking Alert
      <textarea name="email_admin_alert" rows="8"
                style="font-family:monospace;font-size:.8rem;">{{ email_admin_alert }}</textarea>
    </label>
    <small style="color:#64748b;margin-top:-.5rem;margin-bottom:1rem;display:block;">
      Variables: <code>{guest_name}</code> <code>{guest_email}</code> <code>{guest_phone}</code>
      <code>{appt_type}</code> <code>{date_time}</code> <code>{notes}</code>
      <code>{custom_fields}</code>
    </small>

    <button type="submit" class="btn btn-primary">Save Templates</button>
  </form>
</div>
```

**Step 8: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_email_templates.py -v
```
Expected: PASS (4 tests).

**Step 9: Run full test suite**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all PASS.

**Step 10: Commit**

```bash
git add app/services/email.py app/routers/admin.py app/routers/booking.py \
        app/templates/admin/settings.html tests/test_email_templates.py
git commit -m "feat: make email templates editable via admin settings"
```

---

### Task 6: Calendar notification toggle — disable_reminders on create_event

**Files:**
- Modify: `app/services/calendar.py`
- Modify: `app/routers/booking.py`
- Test: `tests/test_calendar_reminders.py`

**Step 1: Write the failing tests**

```python
# tests/test_calendar_reminders.py
import pytest
from unittest.mock import MagicMock, patch
from datetime import datetime
from app.services.calendar import CalendarService


@pytest.fixture
def cal():
    return CalendarService("client_id", "client_secret", "http://localhost/callback")


def _mock_service(cal):
    mock_svc = MagicMock()
    mock_svc.events().insert().execute.return_value = {"id": "evt123"}
    with patch.object(cal, "_build_service", return_value=mock_svc) as p:
        yield mock_svc


def test_create_event_with_disable_reminders_sets_override(cal):
    captured_body = {}
    mock_svc = MagicMock()
    mock_svc.events().insert().execute.return_value = {"id": "evt1"}
    mock_svc.events().insert.side_effect = lambda calendarId, body, sendUpdates: (
        captured_body.update(body) or mock_svc.events().insert()
    )

    with patch.object(cal, "_build_service", return_value=mock_svc):
        cal.create_event(
            refresh_token="tok",
            calendar_id="primary",
            summary="Test",
            description="",
            start=datetime(2026, 3, 1, 10, 0),
            end=datetime(2026, 3, 1, 11, 0),
            disable_reminders=True,
        )

    assert "reminders" in captured_body
    assert captured_body["reminders"]["useDefault"] is False
    assert captured_body["reminders"]["overrides"] == []


def test_create_event_without_disable_reminders_omits_reminders_key(cal):
    captured_body = {}
    mock_svc = MagicMock()
    mock_svc.events().insert().execute.return_value = {"id": "evt2"}
    mock_svc.events().insert.side_effect = lambda calendarId, body, sendUpdates: (
        captured_body.update(body) or mock_svc.events().insert()
    )

    with patch.object(cal, "_build_service", return_value=mock_svc):
        cal.create_event(
            refresh_token="tok",
            calendar_id="primary",
            summary="Test",
            description="",
            start=datetime(2026, 3, 1, 10, 0),
            end=datetime(2026, 3, 1, 11, 0),
            disable_reminders=False,
        )

    assert "reminders" not in captured_body
```

**Step 2: Run tests to verify they fail**

```bash
python3 -m pytest tests/test_calendar_reminders.py -v
```
Expected: FAIL — `create_event` doesn't have `disable_reminders` parameter.

**Step 3: Update `app/services/calendar.py`**

In `create_event`, add `disable_reminders: bool = False` parameter and update the method body:

```python
    def create_event(
        self,
        refresh_token: str,
        calendar_id: str,
        summary: str,
        description: str,
        start: datetime,
        end: datetime,
        attendee_email: str = "",
        location: str = "",
        show_as: str = "busy",
        visibility: str = "default",
        disable_reminders: bool = False,
    ) -> str:
        """Create a calendar event. Returns the event ID."""
        service = self._build_service(refresh_token)
        event = {
            "summary": summary,
            "description": description,
            "start": {"dateTime": start.strftime("%Y-%m-%dT%H:%M:%S") + "Z", "timeZone": "UTC"},
            "end": {"dateTime": end.strftime("%Y-%m-%dT%H:%M:%S") + "Z", "timeZone": "UTC"},
            "transparency": "transparent" if show_as == "free" else "opaque",
            "visibility": visibility,
        }
        if location:
            event["location"] = location
        if attendee_email:
            event["attendees"] = [{"email": attendee_email}]
        if disable_reminders:
            event["reminders"] = {"useDefault": False, "overrides": []}
        result = service.events().insert(calendarId=calendar_id, body=event, sendUpdates="all").execute()
        return result["id"]
```

**Step 4: Update `app/routers/booking.py` to pass `disable_reminders`**

In `submit_booking`, find the owner event creation call and add the parameter:

```python
            event_id = cal.create_event(
                refresh_token=refresh_token,
                calendar_id=appt_type.calendar_id,
                summary=appt_type.owner_event_title or f"{appt_type.name} — {guest_name}",
                description="\n".join(description_lines),
                start=start_utc,
                end=end_utc,
                attendee_email=guest_email,
                location=appt_type.location,
                show_as=appt_type.show_as,
                visibility=appt_type.visibility,
                disable_reminders=not appt_type.owner_reminders_enabled,
            )
```

**Step 5: Run tests to verify they pass**

```bash
python3 -m pytest tests/test_calendar_reminders.py -v
```
Expected: PASS (2 tests).

**Step 6: Run full test suite**

```bash
python3 -m pytest tests/ --ignore=tests/e2e -v
```
Expected: all PASS.

**Step 7: Commit**

```bash
git add app/services/calendar.py app/routers/booking.py tests/test_calendar_reminders.py
git commit -m "feat: add disable_reminders to create_event, wired to owner_reminders_enabled on appointment type"
```

---

### Final: Push to preview for smoke test

```bash
git checkout preview
git merge master
git push origin preview
```

Coolify auto-deploys preview. Visit `http://yscogs0wggcgco8g4wwk0o0g.178.156.247.239.sslip.io`, verify:
- Admin → Appointment Types → create/edit shows new fields
- Photo upload and display on booking page
- Requirements modal works
- Settings → Email Templates section visible
- New bookings use DB templates (or default if blank)

Then merge to production:
```bash
git checkout master
git push origin master
```
